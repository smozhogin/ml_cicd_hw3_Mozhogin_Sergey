name: Model Deployment

on:
    push:
        branches: [main]
    pull_request:
        branches: [main]

jobs:
    build:
        runs-on: ubuntu-latest

        steps:
            - name: Checkout Code
              uses: actions/checkout@v4

            - name: Set-up Python
              uses: actions/setup-python@v5
              with:
                  python-version: "3.11"

            - name: Install Dependencies
              run: pip install -r requirements.txt

            - name: Run Tests
              run: pytest -v

    deploy:
        runs-on: ubuntu-latest
        needs: build

        steps:
            - name: Checkout Code
              uses: actions/checkout@v4

            - name: Prepare Repository Name
              id: prep
              run: |
                  echo "REPO_NAME=$(echo '${{ github.repository }}' | tr '[:upper:]' '[:lower:]')" >> $GITHUB_ENV

            - name: Log into GHCR
              run: |
                  echo "${{ secrets.PERSONAL_GHCR_TOKEN }}" | docker login ghcr.io -u "${{ github.actor }}" --password-stdin

            - name: Build Docker Image
              run: |
                  docker build -t ghcr.io/${REPO_NAME}:${{ github.sha }} .

            - name: Push Image to GHCR
              run: |
                  docker push ghcr.io/${REPO_NAME}:${{ github.sha }}

            - name: Deploy on the Runner
              run: |
                docker compose -f docker-compose.blue.yml -f docker-compose.green.yml -f docker-compose.nginx.yml up -d

            - name: Smoke Test /health
              run: |
                sleep 10
                curl -f http://localhost:8086/health

            - name: Smoke Test /predict
              run: |
                curl -f -X POST http://localhost:8086/predict -H "Content-Type: application/json" -d '{"X":[5.2,4.5,1.5,1.2]}'